
<!DOCTYPE html> 

<html> 
	<title> Otaku Hub Anime Recommender </title> 
	<meta name ="viewpoint" content = "width=device-width, initial-scale = 1.0"> 
	<link href  = "css/bootstrap.min.css" rel = "stylesheet"> 
	<link href  = "css/styles.css" rel = "stylesheet"> 
	<script src="http://ajax.googleapis.com/ajax/libs/jquery/1.11.1/jquery.min.js"></script>
	<head> </head> 
	
	<body>
	   
		<div class="row" style="padding-top: 200px">
			<center> <font size="6"> Otaku Hub Anime Recommender </font> </center>
            <div class="col-lg-4"></div>
            <div class="col-lg-4">
			<form id = "UserName"> 
                <div class="input-group">
                    <input type="text" class="form-control text-center" placeholder = "MyAnimelist Username" input name = "AL" > 
                    <span class="input-group-btn">
                        <!-- Remove onClick not work as planned -->
						<button class="btn btn-default" button type="submit" value = "Submit" > GO!</button>
					</span>
                </div><!-- /input-group -->
			 </form> 
            </div><!-- /.col-lg-4 -->
            <div class="col-lg-4"></div>
        </div><!-- /.row -->
		
		<center> Need An Account? <a href = "http://myanimelist.net/register.php"> MyAnimeList.net </a> </center>
		
		<div class="Info" style="padding-top: 250px">
			<center> <font size="4">  || About Us || About Recommender || FAQ || </font> </center>
		</div> 
		<script>
		//I need to add catching for errors
		$( "form" ).submit(function( event ) {
            event.preventDefault();
		    var self = this;
		    var formId = this.id;
		  if(formId=="UserName")
		  {
		    var username= self.AL.value; //retrieve data in field
		    console.log(username)
		    //call get userlist function which does assyncronous call to yql api to get users list
		    //then pass in a second function for it to do when its done geting the information sucessfully
			getUserList(username, function(data){
				document.write(JSON.stringify(data));
				document.write("<br>")
				var animeList="";
				if($.isArray(data.anime))
				{
					$.each(data.anime,  function()
					{
	   					animeList+="title=~"+encodeURI(this.series_title)+"&";
	                	document.write(this.series_title+"<br>");
	              	});
	             }
				else
				{
					animeList+="title=~"+encodeURI(data.anime.series_title)+"&";
					document.write(data.anime.series_title+"<br>")
				}
				//this removes extra "&" at the end
              	animeList=animeList.substr(0,animeList.length-1);
              	console.log(animeList);

              	document.write("<br> This is AnimeData")
				getAnimeData(animeList,function(data){
					if(data.anime != null)
						$.each(data.anime, function(){
							if (this.precision==="TV" && this.type==="TV")
		                		document.write(this.name+"<br>");

						})//close of each
				})//close of getanimedata aunonomous function
			}) //close autonmous getUserList function 
		  }// close form id
		});
		// function that gets users anime list from animelist
		//parammeters are the username and a function
		//return values
		//the function will be preformmed if the call is done sucessfully and data is retrieved.
		function getUserList(username, callback){
			url="http://myanimelist.net/malappinfo.php?u="+username +"&status=all&type=anime";
			query ='select * from xml where url="'+url+'"';
			 var yqlAPI = 'https://query.yahooapis.com/v1/public/yql?q=' + encodeURIComponent(query) + ' &format=json&env=store%3A%2F%2Fdatatables.org%2Falltableswithkeys&callback=?';

			$.getJSON(yqlAPI, function(){
			      //console.log("sucess");
			  })
			.success(function(r){
			  console.log("sucess")
			  //console.log(r.query.results);
			  if (typeof r.query.results.myanimelist == 'undefined') 
			  {
			  	//add throw an error
			  	console.log("returned null: data wasn't found for specific user")
			  }
			  else
			  	callback(r.query.results.myanimelist)
			  
			})  
			.fail(function(r){
			  console.log("fail");
			  console.log(r);
			});
		
		}
		//function that will retrieve more detail information for each anime
		//a string with the names of animes alrady formated for this specific api call
		//a callback function
		//and when its done doing all calls send the data to call back function
		//returns the data
		function getAnimeData(animelist, callback)
		{
			url="http://cdn.animenewsnetwork.com/encyclopedia/api.xml?"+animelist;
			query ='select * from xml where url="'+url+'"';
			 var yqlAPI = 'https://query.yahooapis.com/v1/public/yql?q=' + encodeURIComponent(query) + ' &format=json&env=store%3A%2F%2Fdatatables.org%2Falltableswithkeys&callback=?';
			 console.log(yqlAPI);
			$.getJSON(yqlAPI, function(){
			      //console.log("sucess");
			  })
			.success(function(r){
			  console.log("sucess")
		  	  if (r.query.results == null) 
			  {
			  	//add throw an error
			  	console.log("returned null: data wasn't found for specific anime/s")
			  }
			  else
			  	callback(r.query.results.ann)
			  
			})  
			.fail(function(r){
			  console.log("fail");
			  console.log(r);
			});

		}
		</script>
	</body> 
	
	
</html> 